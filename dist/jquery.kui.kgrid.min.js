/*! kui - v0.0.1 - 2015-01-29
* https://github.com/konecta/kui
* Copyright (c) 2015 Nelson Paez; Licensed MIT */
/*! 
 *
 *   +++++++++++++++++++++ kGrid +++++++++++++++++++++ 
 *
 */
!function(a){a.kGrids={instances:{}},a.fn.kGrid=function(c,d){return this.each(function(){if("string"==typeof c){var e=a.kGrids.instances[this.id];if(void 0===e||null===e)return;switch(c){case"recargar":void 0!==d&&e.set_data(d),e.cargar();break;case"pagina":if(void 0===d)return;var f=parseInt(d);if(isNaN(f))switch(f=0,d){case"primera":f=1;break;case"anterior":f=parseInt(e.pagina)-1;break;case"siguiente":f=parseInt(e.pagina)+1;break;case"ultima":f=e.totalPaginas;break;default:return}if(1>f||f>parseInt(e.totalPaginas))return;e.set_data({page:f}),e.cargar();break;case"buscar":if(void 0===d)return;var g="AND";void 0!==d.groupOp&&(g=d.groupOp);var h=[];a.each(d.reglas,function(a,b){h.push({field:b.field,data:void 0!==b.data?b.data:d.data,op:void 0!==b.op?b.op:"cn"})}),e.set_data({_search:!0,filters:JSON.stringify({groupOp:g,rules:h})}),e.set_data({page:1}),e.cargar();break;case"seleccionar":e.seleccionar(d);break;case"agregar":e.agregar(d);break;default:return}}else{var i=new b(this,c);a.kGrids.instances[this.id]=i}})};var b=function(b,c){if(void 0===c.url||void 0===c.id||void 0===c.campos)return void window.console.error("Los campos id, url y campos son obligatorios.");void 0===c.ajax&&(c.ajax="GET"),void 0===c.data&&(c.data={}),void 0===c.titulos&&(c.titulos=!0),void 0===c.permisos&&(c.permisos={}),void 0===c.retorno&&(c.retorno={}),void 0===c.botones&&(c.botones=[]),void 0===c.paginador&&(c.paginador=a("<div>").addClass("text-center").appendTo(b));var d={_search:!1,filters:null,page:1,rows:10,sidx:c.id,sord:"asc",todos:!1};c.tarjetas&&(d.rows=5),a.each(c.data,function(a,b){d[a]=b});var e={editar:null,guardar:null,activar:null,remover:null};if(a.each(c.permisos,function(a,b){e[a]=b}),c.seleccionable){var f={nombre:"kGrid_seleccionado",titulo:"",tipo:"booleano",ancho:1,atributos:{readonly:"false",disabled:"false","class":b.id+"_seleccionar_row"}};c.campos.unshift(f),c.seleccionados||(c.seleccionados=[])}this.div=b,this.url=c.url,this.data=d,this.id=c.id,this.tarjetas=c.tarjetas,this.mostrar_titulos=c.titulos,this.etiquetas=[],this.campos=c.campos,this.ajax=c.ajax,this.permisos=e,this.botones=c.botones,this.estado=c.estado,this.load_complete=c.loadComplete,this.paginador=c.paginador,this.onclick=c.onclick,this.ondblclick=c.ondblclick,this.seleccionable=c.seleccionable,this.seleccionados={},this.preseleccionados=c.seleccionados,this.nuevos=0,this.enlace_dummy="javascript"+":".toLowerCase()+"void(0)",this.cargar_estilos(),this.cargar_paginador(),this.titulos(),this.cargar(),a(b).on("reloadGrid",function(){a.kGrids.instances[this.id].cargar()})};b.prototype={set_data:function(b){var c=this;a.each(b,function(a,b){c.data[a]=b})},nueva_grilla:function(){var b=this;a(b.div).addClass("kgrid form-horizontal"),b.contenido=a("<div>").attr("id",b.div.id+"_grilla").prependTo(b.div),b.seleccionable&&b.seleccionar(b.preseleccionados)},nuevo_mensaje:function(b,c){var d=this;d.mensaje&&d.mensaje.remove(),d.mensaje=a("<div>").attr("role","alert").addClass("alert").addClass(b?b:"alert-info").html(c).prependTo(d.contenido),a("<button>").attr("data-dismiss","alert").addClass("close").attr("type","button").html('<i class="fa fa-times"></i>').appendTo(d.mensaje)},titulos:function(){var b=this;if(!b.tarjetas){var c=a("<div>").addClass("form-group hidden-xs hidden-sm"),d=a("<div>").addClass("col-md-11").appendTo(c);b.nueva_grilla(),a.each(b.campos,function(c,e){var f=a("<h4>");f.append(void 0!==e.titulo?e.titulo:e.nombre),b.etiquetas.push(f.html()),a("<i>").addClass("fa fa-fw fa-arrow-down text-muted").prependTo(f),e.ancho||(e.ancho=parseInt(12/b.campos.length));var g=a("<div>").html(f).addClass("col-md-"+e.ancho).appendTo(d);if(b.seleccionable&&0===c){g.addClass("text-center");var h=a("<input>").attr("id",b.div.id+"_seleccionar_todo").attr("type","checkbox").change(function(){var c=a(this).is(":checked");a("."+b.div.id+"_seleccionar_row").each(function(b,d){a(d).prop("checked",c),a(d).trigger("change")})});f.html(h)}}),c.prependTo(b.div),b.mostrar_titulos||c.hide()}},cargar:function(){var b=this;b.contenido?b.contenido.empty():b.nueva_grilla(),a.ajax({type:b.ajax,url:b.url,data:b.data,success:function(c){if(c.error)c.mensaje&&b.nuevo_mensaje(c.tipoMensaje,c.mensaje);else{var d=c.respuesta.datos,e={};b.totalDatos=c.respuesta.totalDatos,b.pagina=c.respuesta.pagina,b.totalPaginas=Math.ceil(b.totalDatos/b.data.rows),b.grilla=a("<div>").addClass("kGrid").prependTo(b.contenido),a.each(d,function(a,c){e[c[b.id]]=c,b.cargar_entrada(c)}),a(b.grilla).find("."+b.div.id+"_seleccionar_row").each(function(c,d){b.seleccionados[a(d).data("pk")]&&a(d).attr("checked","checked"),a(d).change(function(){b.cambiar_seleccion(a(d).data("pk"),a(d).is(":checked"))})}),b.tarjetas&&(b.grilla.find(".kscore").each(function(b,c){var d=.8*parseInt(a(c).parent().parent().parent().height());a(c).css("width",d),a(c).css("height",d)}),b.grilla.find(".kacciones,.kscores").each(function(b,c){var d=a(c).parent().parent().height()-a(c).height(),e=a(c).next();e.hasClass("kscores")&&!e.is(":empty")?a(c).css("font-size","0.5em"):d/=2,d>0&&a(c).css("padding-top",d)})),a(b.div).data("datos",e),a(b.div).data("totalDatos",b.totalDatos),a(b.div).data("pagina",b.pagina),a(b.div).data("totalPaginas",b.totalPaginas),a("#kGrid_"+b.div.id+"_pagina").val(b.pagina).data("pagina",b.pagina),a("#kGrid_"+b.div.id+"_totalPaginas").html(b.totalPaginas),a("#kGrid_"+b.div.id+"_primera_pagina").attr("disabled",1===b.pagina),a("#kGrid_"+b.div.id+"_pagina_anterior").attr("disabled",1===b.pagina),a("#kGrid_"+b.div.id+"_ultima_pagina").attr("disabled",b.pagina===b.totalPaginas),a("#kGrid_"+b.div.id+"_siguiente_pagina").attr("disabled",b.pagina===b.totalPaginas)}"function"==typeof b.load_complete&&b.load_complete.call(this,c)},async:!1})},cargar_entrada:function(b){var c=this,d=void 0===b,e="kGrid_"+c.div.id+"_"+(d?"nuevo_"+c.nuevos:b[c.id]);if(d){if(a("#"+e).is(":visible")){var f=a("#"+e).find("input[data-editando]").first();return void(f.length?f.focus():(c.nuevos++,c.cargar_entrada(b)))}if(c.tarjetas||!c.permisos.guardar)return void window.console.error('Para agregar entradas vacías la grilla no debe ser tipo tarjeta y debe configurar el permiso "guardar"');b={}}var g=a("<div>").attr("id",e).attr("data-pk",b[c.id]).addClass("form-group"+(c.tarjetas?" well":"")),h=d?!0:!1;if(d||"function"!=typeof c.estado||(h=c.estado.call(this,b)),c.onclick){var i="function"==typeof c.onclick?c.onclick:function(){window.open(c.onclick,"_self")};g.addClass("kbtn").click(function(){i.call(this,b)})}else if(c.ondblclick&&("function"==typeof c.ondblclick||h&&"function"==typeof c.permisos.editar)){var j="function"==typeof c.ondblclick?c.ondblclick:function(){c.permisos.editar.call(this,b)};g.dblclick(function(){j.call(this,b)})}var k=a(c.permisos.guardar?"<form>":"<div>").addClass("col-md-"+(c.tarjetas?"7":"11")).appendTo(g),l=a("<div>").addClass("text-right col-md-"+(c.tarjetas?"5":"1")).appendTo(g),m=a("<div>").addClass("pull-right").addClass("kacciones").appendTo(l),n=a("<div>").addClass("kscores pull-right").appendTo(l);a.each(c.campos,function(e,f){var g;if("score"!==f.tipo){var h=f.ancho,i="<div>";c.tarjetas&&(h=6,i="<p>",("destacado"===f.tipo||"encabezado"===f.tipo)&&(h=12),"encabezado"===f.tipo&&(i="<h2>")),g=a(i).addClass("col-md-"+h).appendTo(k)}else g=a("<p>").appendTo(a("<div>").addClass("text-center pull-left kscore").appendTo(n));if(c.tarjetas||a("<label>").addClass("klabel").addClass("visible-xs visible-sm").html(c.etiquetas[e]).appendTo(g),c.tarjetas)g.html("function"==typeof f.formato?f.formato.call(this,b[f.nombre],b):b[f.nombre]),f.titulo&&""!==f.titulo&&("score"!==f.tipo?a("<label>").addClass("text-muted").html(f.titulo+"&nbsp; &nbsp;").prependTo(g):(a("<br>").appendTo(g),a("<small>").html(f.titulo).appendTo(g)));else{void 0===f.simple&&(f.simple=!0),a.kui.formulario.nuevo_elemento(!d,g,b,f);var j=g.find("[data-rol=input]");j.hasClass(c.div.id+"_seleccionar_row")||j.attr("readonly",!0),"checkbox"===j.attr("type")&&(j.attr("data-pk",b[c.id]).dblclick(function(a){a.stopPropagation()}),j.attr("readonly")&&j.attr("disabled","disabled"),j.parent().addClass("text-center"))}"function"==typeof f.formato&&(b[f.nombre]=f.formato.call(this,b[f.nombre],b))});var o=c.tarjetas?"fa-3x":"fa-lg",p=function(b,d,f,g){var h=a("<a>").attr("id",e+"_"+b).addClass("text-muted kaccion").attr("title",d).attr("href",c.enlace_dummy).html('<i class="fa '+o+" fa-"+f+'"></i>').hover(function(){a(this).removeClass("text-muted").addClass("text-"+g)},function(){a(this).addClass("text-muted").removeClass("text-"+g)});return h},q=function(){a("#"+e+" form").find("input[readonly]").each(function(b,c){("true"!==a(c).attr("data-disabled")&&"true"!==a(c).attr("data-readonly")||d&&a(c).attr("data-creable"))&&a(c).removeAttr("readonly").removeAttr("disabled").attr("data-editando",!0).keyup(function(b){13===b.keyCode&&(b.preventDefault(),a("#"+e+" form").submit())})}),a("#"+e+"_editar").hide(),d||(a("#"+e+"_remover").hide(),a("#"+e+"_deshacer").fadeIn()),a("#"+e+"_guardar").fadeIn(),a("#"+e).find("input[data-editando]").first().focus()},r=function(){a("#"+e+" form").find("input[data-editando]").each(function(b,c){a(c).attr("readonly","false"!==a(c).attr("data-readonly")).removeAttr("data-editando").unbind("keyup"),"checkbox"===a(c).attr("type")&&a(c).attr("disabled","false"!==a(c).attr("data-disabled"))}),a("#"+e+"_guardar").hide(),a("#"+e+"_deshacer").hide(),a("#"+e+"_editar").fadeIn(),a("#"+e+"_remover").fadeIn()},s=function(){var b=a(c.div).data("datos")[a("#"+e).attr("data-pk")],d=a("#"+e+" form").find("input[data-editando]");r(),d.each(function(c,d){"checkbox"===a(d).attr("type")?a(d).prop("checked",b[a(d).attr("name")]):a(d).val(b[a(d).attr("name")])})};if(h){if(c.permisos.editar){var t=p("editar","Editar","pencil","primary");if("function"==typeof c.permisos.editar)t.click(function(a){a.stopPropagation(),c.permisos.editar.call(this,b)});else if(c.permisos.guardar){var u=p("guardar","Guardar","save","primary");u.hide();var v="function"==typeof c.permisos.guardar?function(a){c.permisos.guardar.call(this,a)}:function(b){a.ajax({type:"POST",url:c.permisos.guardar,data:b,success:function(){c.cargar()}})};a.kui.formulario.validar.reglas(),a(k).validate({showErrors:function(b,c){a.kui.formulario.validar.error(this,b,c)},submitHandler:function(c){return a.kui.formulario.validar.fecha(c),r(),a.each(a("#"+e+" form").serializeArray(),function(a,c){b[c.name]=c.value}),v(b),!1}}),u.click(function(b){b.stopPropagation(),a("#"+e+" form").submit()}).appendTo(m);var w=p("deshacer","Deshacer cambios","undo","danger");w.hide().click(function(a){a.stopPropagation(),s()}).appendTo(m),t.click(function(a){a.stopPropagation(),q()})}d||t.appendTo(m)}if(c.permisos.remover){var x=p("remover","Remover","times","danger");x.click(d||"function"!=typeof c.permisos.remover?function(b){b.stopPropagation(),a("#"+e).remove()}:function(a){a.stopPropagation(),c.permisos.remover.call(this,b)}),x.appendTo(m)}}else if("function"==typeof c.permisos.activar){g.addClass("has-error");var y=p("reactivar","Reactivar","check","success");y.click(function(a){a.stopPropagation(),c.permisos.activar.call(this,b)}).appendTo(m)}a.each(c.botones,function(d,e){if("function"!=typeof e.mostrar||e.mostrar.call(this,b)){var f=a("<a>").attr("title",e.comentario).addClass("text-muted kaccion").attr("href",void 0!==e.enlace?e.enlace:c.enlace_dummy).html('<i class="fa '+o+" "+e.icono+'"></i>').hover(function(){a(this).removeClass("text-muted")},function(){a(this).addClass("text-muted")});void 0!==e.onclick&&f.click(function(a){a.stopPropagation(),e.onclick.call(this,b)}),void 0!==e.atributos&&a.each(e.atributos,function(a,b){f.attr(a,b)}),f.appendTo(m)}}),d?(g.prependTo(c.grilla),q()):g.appendTo(c.grilla),c.tarjetas||g.after(a("<hr>").addClass("visible-xs visible-sm"))},cargar_paginador:function(){var b=this;if(a(b.paginador).length){var c="kGrid_"+b.div.id+"_",d=a("<div>").attr("id",c+"paginador").addClass("kGrid-paginador btn-group").appendTo(b.paginador);a("<button>").attr("id",c+"primera_pagina").attr("type","button").addClass("btn btn-default").html(a("<i>").addClass("fa fa-step-backward")).appendTo(d).click(function(){a("#"+b.div.id).kGrid("pagina","primera")}),a("<button>").attr("id",c+"pagina_anterior").attr("type","button").addClass("btn btn-default").html(a("<i>").addClass("fa fa-backward")).appendTo(d).click(function(){a("#"+b.div.id).kGrid("pagina","anterior")});var e=a("<div>").addClass("btn btn-default kpagina").css("height",a("#"+c+"pagina_anterior").outerHeight()).appendTo(d);a("<label>").html("Página ").appendTo(e),a("<input>").attr("id",c+"pagina").attr("type","text").addClass("pagina").css("width",a("#"+c+"pagina_anterior").outerWidth()).appendTo(e).keyup(function(d){if(13===d.keyCode){d.preventDefault();var e=parseInt(a("#"+c+"pagina").val());if(isNaN(e)||0>e||e>b.totalPaginas)return void a("#"+c+"pagina").val(a("#"+c+"pagina").data("pagina"));e!==a("#"+c+"pagina").data("pagina")&&a("#"+b.div.id).kGrid("pagina",e)}});var f=a("<label>").html(" de ").appendTo(e);a("<span>").attr("id",c+"totalPaginas").appendTo(f),a("<button>").attr("id",c+"siguiente_pagina").attr("type","button").addClass("btn btn-default").html(a("<i>").addClass("fa fa-forward")).appendTo(d).click(function(){a("#"+b.div.id).kGrid("pagina","siguiente")}),a("<button>").attr("id",c+"ultima_pagina").attr("type","button").addClass("btn btn-default").html(a("<i>").addClass("fa fa-step-forward")).appendTo(d).click(function(){a("#"+b.div.id).kGrid("pagina","ultima")})}},cargar_estilos:function(){if(!a("#kgrid_estilos").length){var b={".kgrid .kbtn":["cursor: pointer"],".kgrid .kbtn:hover":["background: #ECECF0","border: 1px solid #cacaca"],".kgrid h2":["padding-bottom: 10px"],".kgrid .kscore":["width: 0","height: 0","border: 1px solid #999999","background: #ECECF0","font-size: 1.7em","margin-left: 10px","overflow: hidden","border-radius: 50%"],".kgrid .kscore p":["margin-top: 25%"],".kgrid .kscore small":["font-size: 0.5em"],".kgrid .klabel":["margin-top: 20px"],".kgrid .kaccion":["margin-left: 15px"],".kgrid .kpagina":["overflow: hidden","padding-top: 2px"],".kgrid .kpagina input":["margin: 0 5px","text-align: center"]},c="";a.each(b,function(b,d){c+=b+"{",a.each(d,function(a,b){c+=b+";"}),c+="}"});var d=a("head").find("link,style").first(),e=a("<style>").attr("id","kgrid_estilos").html(c);d.length?d.before(e):e.prependTo("head")}},cambiar_seleccion:function(a,b){var c=this;c.seleccionados[a]=b,c.refrescar_seleccionados()},seleccionar:function(b){var c=this;c.seleccionados={},a.each(b,function(a,b){c.seleccionados[b]=!0}),a("."+c.div.id+"_seleccionar_row").each(function(b,d){a(d).removeAttr("checked"),c.seleccionados[a(d).data("pk")]&&a(d).prop("checked",!0)}),c.refrescar_seleccionados()},refrescar_seleccionados:function(){var b=this,c=[];a.each(b.seleccionados,function(a,b){b&&c.push(a)}),a(b.div).data("seleccionados",c)},agregar:function(a){var b=this;b.cargar_entrada(a)}}}(jQuery);